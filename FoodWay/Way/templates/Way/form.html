{% extends "Home/base_layer.html" %}

{% block content %}
<style>
    #map {
        display: block;
        width: 100%;
        height: 100%;
    }

    .content-map {
        width: 85vw;
        height: 80vh;
    }
</style>

<div class="d-flex flex-row justify-content-around mt-1">
    <div class="content-map">
        <div id="map"></div>
    </div>
</div>
<form>
    
</form>

<script>
    DG.then(function () {
        var options = {
            center: [53.20973372247789, 44.99897003173828],
            zoom: 13,
            geoclicker: true,
            worldCopyJump: true,
            zoomControl: false,
            fullscreenControl: false,
            geoclicker: false
        };
        var query = parseQuery();
        var map = window.map = DG.map('map', getMapOptions(query, options));

        var controlOptions = DG.Browser.mobile ? { position: 'bottomright' } : {};
        DG.control.zoom(controlOptions).addTo(map);
        DG.control.traffic(controlOptions).addTo(map);
        DG.control.location(controlOptions).addTo(map);
        DG.control.ruler(controlOptions).addTo(map);
        if (DG.screenfull.isAvailable()) {
            DG.control.fullscreen(controlOptions).addTo(map);
        }
        var balloonHTML = '<a href="http://www.2gis.ru/" target="_blank">\n\
        <img src="__BASE_URL__/img/2gis-logo.png" alt="2GIS" title="2GIS" width="154" height="66" style="border: none"></a>\n\
        <p>Компания «ДубльГИС»</p>Тел.: (383) 363-05-55<br />Адрес: г. Новосибирск, Карла Маркса площадь, 7<br />\n\
        (МФК «Сан Сити»), 13 этаж';
        //var marker = DG.marker([53.20973372247789, 44.99897003173828]).addTo(map).bindPopup(balloonHTML);

        //var latlngs = [
        //    [53.20973372247789, 44.99897003173828],
        //    [53.20973372247789, 44.99897003173858],
        //    [53.20973372247789, 44.99897003173868],
        //    [53.20973372247729, 44.99897003173828],
        //    [82.91699, 55.042136]
        //];
        var polyline = DG.polyline(0, { color: 'red' }).addTo(map);
        //map.fitBounds(polyline.getBounds());

        var userMarker = DG.marker([54.980156831455, 82.897440725094], {
            draggable: true
        }).addTo(map);

        userMarker.on('moveend', function (e) {
            var lat = e.target._latlng.lat,
                lng = e.target._latlng.lng;
            //save_marker();
        });
        //marker.openPopup();


        function save_marker() {
            DG.marker([userMarker.getLatLng().lat, userMarker.getLatLng().lng]).addTo(map);
        }

        map.on('click', function (e) {
            console.log(e.latlng.lat + '   ' + e.latlng.lng);
            userMarker.setLatLng([e.latlng.lat, e.latlng.lng]);

            polyline.addLatLng([e.latlng.lat, e.latlng.lng]);
        });

        map.on('popupopen', function (e) {
            console.log(e);
            
            //console.log(polyline.toGeoJSON());
            //var test = e['popup'].getContent();
            //console.log(test);
            //$('#info').html(test);
        });

        map.on('moveend', function () {
            if (!history.replaceState) {
                return; // ie <= 9
            }

            var center = map.getCenter();
            history.replaceState({}, document.title,
                '?lng=' + center.lng.toFixed(5) +
                '&lat=' + center.lat.toFixed(5) +
                '&zoom=' + map.getZoom()
            );
        });
    });


    function parseQuery() {
        var res = {};
        location.search.slice(1).split('&')
            .map(function (str) {
                return str.split('=')
            })
            .forEach(function (couple) {
                res[couple[0]] = couple[1];
            });
        return res;
    }

    function getMapOptions(query, options) {
        if (query.lng !== undefined && query.lat !== undefined) {
            options.center = [parseFloat(query.lat), parseFloat(query.lng)];
        }
        if (query.zoom !== undefined) {
            options.zoom = parseInt(query.zoom, 10);
        }
        return options;
    }

</script>
{% endblock content %}